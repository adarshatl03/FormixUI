name: Sync Tasks to Issues

on:
  push:
    paths:
      - ".agent/dev_plan/DEVELOPMENT_TASKS.md"
    branches:
      - main
      - master
      - develop
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  sync_tasks:
    runs-on: ubuntu-latest

    # ---------------------------------------------------------
    # CONFIGURATION
    # ---------------------------------------------------------
    env:
      PROJECT_NUMBER: 1 # <--- UPDATE THIS TO YOUR PROJECT NUMBER

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Parse Markdown and Sync Issues
        uses: actions/github-script@v7
        with:
          # REQUIRED: Secret 'PROJECT_TOKEN' must be a PAT with 'project' scope
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const taskFilePath = '.agent/dev_plan/DEVELOPMENT_TASKS.md';

            // Configuration
            const projectNumber = parseInt(process.env.PROJECT_NUMBER);
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            if (!fs.existsSync(taskFilePath)) {
              console.log(`File not found: ${taskFilePath}`);
              return;
            }

            const content = fs.readFileSync(taskFilePath, 'utf8');
            const lines = content.split('\n');

            // Regex 1: Standard Checkboxes: - [ ] **Title**: Desc
            const checkboxRegex = /^- \[(.|x|X)\] \*\*(.*?)\*\*:?(.*)/;

            // Regex 2: Recurring Tasks: - ðŸ”„ Title
            const recurringRegex = /^- ðŸ”„ (.*)/;

            const desiredState = {}; // Map<Title, { state: 'open'|'closed', labels: string[], body: string }>

            lines.forEach(line => {
              // 1. Check for Standard Tasks
              const cbMatch = line.match(checkboxRegex);
              if (cbMatch) {
                const isChecked = cbMatch[1].toLowerCase() === 'x';
                const title = cbMatch[2].trim();
                const body = cbMatch[3].trim();
                
                desiredState[`Feat: ${title}`] = {
                  state: isChecked ? 'closed' : 'open',
                  body: body || "Task from Feature Matrix",
                  labels: ['enhancement', 'feature-matrix']
                };
                return;
              }

              // 2. Check for Recurring Tasks (Always Open)
              const recMatch = line.match(recurringRegex);
              if (recMatch) {
                const title = recMatch[1].trim();
                // We prefix with "Maint:" for maintenance/recurring
                desiredState[`Maint: ${title}`] = {
                  state: 'open', // Always open
                  body: "Recurring maintenance task from Development Plan.",
                  labels: ['maintenance', 'recurring']
                };
              }
            });

            if (Object.keys(desiredState).length === 0) {
              console.log("No tasks found to sync.");
              return;
            }

            console.log(`Processing ${Object.keys(desiredState).length} tasks...`);

            // ---------------------------------------------------------
            // 1. Get Project ID (GraphQL)
            // ---------------------------------------------------------
            let projectId = null;
            try {
              // Assuming USER project. If Org, change `user(login: $owner)` to `organization(login: $owner)`
              const query = `
                query($owner: String!, $number: Int!) {
                  user(login: $owner) {
                    projectV2(number: $number) {
                      id
                    }
                  }
                }
              `;
              const data = await github.graphql(query, { owner, number: projectNumber });
              projectId = data.user?.projectV2?.id;
              
              if (projectId) {
                console.log(`Found Project ID: ${projectId}`);
              } else {
                console.log("Project not found (Check Owner/Number). Skipping Project Sync.");
              }
            } catch (e) {
              console.log("Could not find Project via GraphQL. Check PROJECT_TOKEN permissions. Skipping Project Sync.");
              console.log(e.message);
            }

            // ---------------------------------------------------------
            // 2. Fetch Existing Issues
            // ---------------------------------------------------------
            const existingIssues = await github.paginate(github.rest.issues.listForRepo, {
              owner, repo, state: 'all', per_page: 100
            });
            const existingMap = new Map();
            existingIssues.forEach(i => existingMap.set(i.title, i));

            // ---------------------------------------------------------
            // 3. Sync Logic
            // ---------------------------------------------------------
            for (const [title, data] of Object.entries(desiredState)) {
              const existing = existingMap.get(title);

              if (!existing) {
                // CREATE NEW ISSUE
                if (data.state === 'open') {
                  console.log(`Creating NEW issue: ${title}`);
                  const newIssue = await github.rest.issues.create({
                    owner, repo, title,
                    body: `${data.body}\n\n*Source: ${taskFilePath}*`,
                    labels: data.labels
                  });
                  
                  // ADD TO PROJECT
                  if (projectId && newIssue.data.node_id) {
                    try {
                      await github.graphql(`
                        mutation($projectId: ID!, $contentId: ID!) {
                          addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) {
                            item { id }
                          }
                        }
                      `, { projectId, contentId: newIssue.data.node_id });
                      console.log(`Added ${title} to Project`);
                    } catch (e) {
                      console.log(`Failed to add to project: ${e.message}`);
                    }
                  }
                   await new Promise(r => setTimeout(r, 1000)); 
                }
              } else {
                // UPDATE EXISTING ISSUE
                if (existing.state !== data.state) {
                  console.log(`Updating ${title} -> ${data.state}`);
                  await github.rest.issues.update({
                    owner, repo, issue_number: existing.number, state: data.state
                  });
                   await new Promise(r => setTimeout(r, 1000));
                }
              }
            }
